<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lap Timer</title>
  <style>
    body {
      margin: 0; font-family: 'Segoe UI', sans-serif;
      background: #121212; color: #eee;
      display: flex; flex-direction: column; height: 100vh;
    }
    #top {
      display: flex; justify-content: space-between;
      padding: 15px; background: #1f1f1f;
    }
    #videoContainer {
      position: relative; width: 320px; height: 240px;
      border: 3px solid #444; border-radius: 8px; overflow: hidden;
    }
    #video {
      width: 100%; height: 100%; object-fit: cover;
    }
    #centerLine {
      position: absolute; top: 0; left: 50%;
      width: 3px; height: 100%; background: #ff4136;
      transform: translateX(-50%);
    }
    #stats {
      display: flex; flex-direction: column;
      justify-content: center; width: 360px;
      background: #222; border-radius: 8px;
      padding: 20px;
    }
    #stats > div {
      margin-bottom: 12px; font-size: 1.2rem;
    }
    #status {
      font-size: 1.6rem; font-weight: bold; color: #ff4136;
    }
    #lapTableContainer {
      flex: 1; overflow-y: auto; background: #1f1f1f;
      margin: 15px; border-radius: 8px;
    }
    table {
      width: 100%; border-collapse: collapse;
    }
    thead {
      background: #ff4136; color: white;
    }
    th, td {
      padding: 10px; text-align: center;
      border-bottom: 1px solid #333;
    }
    tr:nth-child(even) { background: #2c2c2c; }
    #controls {
      padding: 15px; background: #222;
      display: flex; justify-content: center;
      gap: 10px;
    }
    select, input[type=number], button {
      padding: 6px 10px; font-size: 1rem;
      border-radius: 5px; border: none;
    }
    button {
      background: #ff4136; color: #fff;
      cursor: pointer;
    }
    button:hover:not(:disabled) {
      background: #e02f1f;
    }
    button:disabled {
      background: #7a1e12; cursor: not-allowed;
    }
  </style>
</head>
<body>

<div id="top">
  <div id="videoContainer">
    <video id="video" autoplay muted playsinline></video>
    <div id="centerLine"></div>
  </div>

  <div id="stats">
    <div id="status">Waiting...</div>
    <div id="lapTime">Last lap: -</div>
    <div id="currentPace">Pace: -</div>
    <div id="totalTime" style="font-size: 1.4rem;">Total: 0.00s</div>
    <div id="estimatedFinish">Est. Finish: -</div>
  </div>
</div>

<div id="lapTableContainer">
  <table>
    <thead>
      <tr><th>Lap</th><th>Time (s)</th></tr>
    </thead>
    <tbody id="lapTimesBody"></tbody>
  </table>
</div>

<div id="controls">
  <label for="cameraSelect">Camera:</label>
  <select id="cameraSelect"></select>
  <label for="lapCount">Laps:</label>
  <input type="number" id="lapCount" value="10" min="1">
  <button id="startBtn">Start</button>
</div>

<script>
const video = document.getElementById('video');
const cameraSelect = document.getElementById('cameraSelect');
const lapCountInput = document.getElementById('lapCount');
const startBtn = document.getElementById('startBtn');
const status = document.getElementById('status');
const lapTimesBody = document.getElementById('lapTimesBody');
const totalTimeDiv = document.getElementById('totalTime');
const currentPaceDiv = document.getElementById('currentPace');
const lapTimeDiv = document.getElementById('lapTime');
const estimatedFinish = document.getElementById('estimatedFinish');

let lapsTotal = 0, lapsLeft = 0, lapTimes = [];
let startTime, lapStartTime;
let detecting = false, cooldown = false;
let stream = null;

const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d');

async function getCameras() {
  const devices = await navigator.mediaDevices.enumerateDevices();
  const cams = devices.filter(d => d.kind === 'videoinput');
  cameraSelect.innerHTML = '';
  cams.forEach((cam, i) => {
    const opt = document.createElement('option');
    opt.value = cam.deviceId;
    opt.textContent = cam.label || `Camera ${i + 1}`;
    cameraSelect.appendChild(opt);
  });
}

async function startCamera(id) {
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
  }
  stream = await navigator.mediaDevices.getUserMedia({ video: { deviceId: id } });
  video.srcObject = stream;
}

function beep() {
  const a = new AudioContext();
  const o = a.createOscillator();
  const g = a.createGain();
  o.type = 'sine'; o.frequency.value = 1000;
  o.connect(g); g.connect(a.destination);
  o.start(); g.gain.exponentialRampToValueAtTime(0.00001, a.currentTime + 0.2);
  o.stop(a.currentTime + 0.2);
}

function updateDisplay() {
  const now = performance.now();
  const total = ((now - startTime) / 1000).toFixed(2);
  totalTimeDiv.textContent = `Total: ${total}s`;

  if (lapTimes.length) {
    const last = lapTimes[lapTimes.length - 1].toFixed(2);
    lapTimeDiv.textContent = `Last lap: ${last}s`;
    currentPaceDiv.textContent = `Pace: ${last}s/lap`;
    const pace = parseFloat(last);
    const est = (pace * lapsLeft).toFixed(2);
    estimatedFinish.textContent = `Est. Finish: ${est}s`;
  } else {
    lapTimeDiv.textContent = `Last lap: -`;
    currentPaceDiv.textContent = `Pace: -`;
    estimatedFinish.textContent = `Est. Finish: -`;
  }

  status.textContent = `Laps left: ${lapsLeft}`;
  lapTimesBody.innerHTML = lapTimes.map((t, i) =>
    `<tr><td>${i + 1}</td><td>${t.toFixed(2)}</td></tr>`
  ).join('');
}

function startRace() {
  lapsTotal = lapsLeft = parseInt(lapCountInput.value, 10);
  lapTimes = [];
  startTime = lapStartTime = performance.now();
  detecting = true;
  cooldown = false;
  updateDisplay();
  beep();
  status.textContent = 'Running...';
  startBtn.disabled = true;
  lapCountInput.disabled = true;
  detectMotion();
}

function onLapDetected() {
  if (cooldown || !detecting || lapsLeft === 0) return;
  const now = performance.now();
  const lapTime = (now - lapStartTime) / 1000;
  lapStartTime = now;
  lapTimes.push(lapTime);
  lapsLeft--;
  updateDisplay();
  cooldown = true;
  beep();
  setTimeout(() => cooldown = false, 5000);
  if (lapsLeft === 0) {
    detecting = false;
    status.textContent = 'Finished!';
    startBtn.disabled = false;
    lapCountInput.disabled = false;
  }
}

let prevFrame = null;
function detectMotion() {
  if (!detecting) return;
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);

  if (!prevFrame) {
    prevFrame = frame;
    requestAnimationFrame(detectMotion);
    return;
  }

  const centerX = Math.floor(canvas.width / 2);
  const threshold = 40;
  let motion = 0;

  for (let y = 0; y < canvas.height; y++) {
    for (let x = centerX - 10; x <= centerX + 10; x++) {
      const i = (y * canvas.width + x) * 4;
      const diff = Math.abs(frame.data[i] - prevFrame.data[i]) +
                   Math.abs(frame.data[i + 1] - prevFrame.data[i + 1]) +
                   Math.abs(frame.data[i + 2] - prevFrame.data[i + 2]);
      if (diff > threshold) motion++;
    }
  }

  prevFrame = frame;
  if (motion > 1000) onLapDetected();
  requestAnimationFrame(detectMotion);
}

cameraSelect.onchange = () => startCamera(cameraSelect.value);
startBtn.onclick = () => { if (!detecting) startRace(); };

getCameras().then(() => {
  if (cameraSelect.options.length) {
    startCamera(cameraSelect.value);
  }
});
</script>

</body>
</html>
